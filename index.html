<!DOCTYPE html>
<html>
<head>
  <title>Canvas</title>
  <meta charset="UTF-8" />
  <script src="bigDecimal.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <center><h1 style="height:10px; margin-top:0; margin-bottom: 10px"><a href=https://github.com/dzaima/Canvas>Canvas</a></h1></center>
  <div id="p" style="width:40%;"><span id="bytecount" style="font-size:12px">0 bytes</span></div>
  <div id="textareas">
    <div class="left" id="progdiv">
      <textarea id="program" placeholder="Enter code..." spellcheck="false" onclick="setTimeout(updater, 0);" oninput="setTimeout(updater, 0);" style="height:150px"></textarea>
    </div>
    <div align="left" class="right" id="inpdiv">
      <textarea id="inputs" placeholder="Enter inputs in each line" spellcheck="false" style="width:100%; height:150px"></textarea>
      <div id="docs" style="display:none" align="left">
        <div style="padding-bottom: 5px">
          <input id="search" style="width:93%;" onclick="setTimeout(updater, 0);" oninput="setTimeout(updater, 0);" placeholder="search for chars, descriptions, ect."></input>
        </div>
        <div id="docs-scroll">
          <table id="docstable" style="width:99%" align="left">
            <col width="3%" />
            <col width="95%" />
            <thead>
              <tr>
                <th>chr</th>
                <th>description</th>
              </tr>
            </thead>
          </table>
        </div>
      </div>
      <div id="stepData" style="display:none">
        <span class="codebox">
          <h2>State</h2>
          <span id="codeState" class="code"></span><br><br>
          X = <span id="stateX"></span><br>
          Y = <span id="stateY"></span><br>
          α = <span id="stateAlpha"></span><br>
          ω = <span id="stateOmega"></span><br>
          remainders = <span id="stateRemainders"></span><br>
          superscripts = <span id="stateSups"></span><br>
          background = <span id="bgState"></span><br>
          <h2>Program stack</h2>
          <span class="code" id="ptrstackState"></span>
          <h2>Stack</h2>
          <div class="code" id="stackState"></div>
        </span>
      </div>
    </div>
    <textarea id="result" placeholder="Output will be here" spellcheck="false" style="width:100%; background-color: #333333; height:390px" readonly></textarea>
  </div>
  <div id="buttonPanel">
    <div style="width:120px" class="left">
      <button id="runBtn"   onclick="runMain()"    style="width:100%">run (ctrl+enter) </button>
      <button id="loadFile" onclick="loadFile()" style="width:100%">load encoded file</button>
      <button id="saveFile" onclick="saveFile()" style="width:100%">save encoded file</button>
    </div>
    <div style="width:80px" class="left">
      <button id="permalink" onclick="permalink()"style="width:100%">permalink</button>
      <button id="topost"    onclick="postify()"  style="width:100%">postify  </button>
      <button id="toCMC"     onclick="CMCify()"   style="width:100%">CMCify   </button>
    </div>
    <div class="left" style="width:100px">
      <input id="devChk" type="checkbox" onClick="devUpdate()">dev mode</input><br>
      <div class="left" style="width:60px">
        <button id="loadpermalink" onclick="loadPermalink()" style="width:100%; display:none">reload</button>
        <button id="stepBtn" onclick="step()" style="width:100%; display:none">step</button>
      </div>
    </div>
  </div>
  <input id="fakeFileInp" type="file" style="display:none" />
  <a id="fakeLink" style="display:none" />
  <script>
    var latestVersion = 2;
    var usedVersion = latestVersion;
    var devMode = false;
    var debug = 0; // 0 - no debug; 1 - program debug; 2 - interpreter debug
    var running = false;
    var stepping = false;
    var stepNow = false;
    var devLoaded = false;
    var lastSearch = "";
    if (devChk.checked) devUpdate(); // for Firefox-ish reloads that keep checked
    // loading initial permalinked data
    var args = location.search.substring(1).split(",");
    for (var i = 0; i < args.length; i++) {
      var carg = args[i];
      var parts = carg.split("=")
      if (parts[0]=='u')
        program.value = unescape(atob(parts[1].replace(/_/g, "=")));
      if (parts[0]=='i')
        inputs.value = unescape(atob(parts[1].replace(/_/g, "=")));
      if (parts[0]=='v')
        usedVersion = +parts[1];
      if (parts[0]=='dev') {
        devChk.click();
      }
      if (parts[0]=='search') {
        devChk.click();
        search.value=unescape(parts[1]);
      }
    }
    
    // dev mode
    function devUpdate() {
      
      devMode^= true;
      if (devMode) {
        if (!devLoaded) {
          $.getScript("docs.js");
          devLoaded = true;
        }
        progdiv.appendChild(inputs);
        progdiv.appendChild(result);
        docs.before(buttonPanel);
        inputs.style.width="99%";
        result.style.width="99%";
        docs.style.display = "block";
        loadpermalink.style.display = "block";
        stepBtn.style.display = "block";
        if (!debug) debug = 1;
      } else {
        inpdiv.appendChild(inputs);
        textareas.appendChild(result);
        textareas.after(buttonPanel);
        inputs.style.width="100%";
        result.style.width="100%";
        docs.style.display = "none";
        if (stepping && running) stepNow = true;
        stepping = false;
        stepData.style.display = "none";
        loadpermalink.style.display = "none";
        stepBtn.style.display = "none";
        if (debug == 1) debug = 0;
      }
    }
    
    function loadPermalink(forceOnline) {
      window.location = permalink(forceOnline) + ",dev,run";
    }
    
    function step() {
      if (!stepping) enterStepping();
      if (running) stepNow = true;
      else runMain();
    }
    function enterStepping() {
      stepping = true;
      docs.style.display = "none";
      stepData.style.display = "block";
    }
    function stopStepping() {
      stepping = false;
      docs.style.display = "block";
      stepData.style.display = "none";
    }
    
    // saving to encoded file
    function saveFile() {
      var prog = program.value;
      fakeLink.download = "encoded.canvas";
      var binary = "";
      for (var i = 0; i < prog.length; i++) {
        binary+= String.fromCodePoint(codepage.indexOf(prog.charAt(i)));
      }
      fakeLink.href = 'data:text/plain;base64,' + btoa(binary);
      fakeLink.click();
    }
    // loading from encoded file
    var fr;
    function loadFile() {
      fakeFileInp.click();
    }
    $("#fakeFileInp").change(function () {
      var f = fakeFileInp.files[0];
      fr = new FileReader();
      fr.onload = recieved;
      fr.readAsBinaryString(f);
    });
    function recieved() {
      var binary = fr.result;
      var newProgram = "";
      for (var i = 0; i < binary.length; i++) {
        newProgram+= codepage.charAt(binary.charCodeAt(i));
      }
      program.value = newProgram;
      update();
    }
    function postify() {
      let pl = permalink(true);
      let prog = program.value;
      result.value = `# [Canvas](https://github.com/dzaima/Canvas), ${prog.length} [byte${prog.length===1? "" : "s"}](https://github.com/dzaima/Canvas/blob/master/files/chartable.md)`;
      for (var cs of program.value.split("\n")) result.value+= "\n    "+cs;
      result.value+= `\n\n[Try it here!](${pl})`;
    }
    function CMCify() {
      let pl = permalink(true);
      let prog = program.value;
      result.value =   `Canvas, ${prog.length} byte${prog.length===1? "" : "s"}: [\`${prog.replace(/\n/g, "\\n")}\`](${pl})`;
      result.value+= `\nCanvas, [${prog.length} byte${prog.length===1? "" : "s"}](${pl})`;
    }
    
    // permalink stuff
    function permalink(forceOnline) {
      if (forceOnline) var res = "https://dzaima.github.io/Canvas/?";
      else var res = location.href.substring(0,location.href.length-location.search.length)+"?";
      
      res+= "u="+ (btoa(escape(program.value)).replace(/=/g, "_"));
      var inputs = document.getElementById("inputs").value;
      if (inputs != "")
        res+= ",i="+ btoa(escape(inputs)).replace(/=/g, "_");
      res+= ",v="+version
      result.value = res;
      return res;
    }
    // byte count updating & program running
    function runMain() {
      if (running) return;
      running = true;
      run(program.value, inputs.value.split("\n").map(
        (s) => {
          var ev;
          try {
            ev = eval(s);
          } catch (e) {
            ev = undefined;
          }
          if (typeof ev == "number") ev = new Big(s);
          return ev == undefined? s : ev
        })
      );
    }
    function updater() {
      setTimeout (update, 0);
      setTimeout (update, 10);
    }
    function update() {
      var bytecount = program.value.length;
      var startPos = program.selectionStart;
      var endPos = program.selectionEnd;
      var co = bytecount +" byte"+ (bytecount==1? "" : "s");
      if (endPos != startPos)
        co+= " ("+ (endPos-startPos) +" byte"+ (endPos-startPos==1? "" : "s") +" selected)"
      document.getElementById("bytecount").innerHTML = co;
      if (search.value != lastSearch && typeof searched !== 'undefined') searched(search.value);
      //console.log(startPos+" "+endPos);
    }
    document.addEventListener ("keydown", e=> {
      if (e.ctrlKey && e.code === "KeyB") {
        bpS = document.getElementById("program").selectionStart;
        bpE = document.getElementById("program").selectionEnd;
      }
      //console.log(e.code);
      if (e.ctrlKey && e.code === "Enter") {
        runMain();
      }
    });
    document.onkeydown = updater;
    update();
    // loading the appropriate version JS file
    var JSname = latestVersion === usedVersion? "main.js" : "old/main"+usedVersion+".js";
    var doneSteps = 0;
    $.ajax({
      url: JSname,
      success: function (JScode) {
        try {
          eval("async()=>{}")
        } catch(e) {
          JScode = JScode.replace(/\b(async|await)\b/g, "");
          console.log("Looks like async isn't supported. Removing it from the code with Regex. Programs which run indefinitely can (and should) hang the page.");
        }
        window.eval(JScode);
        console.log("main.js loaded!");
        doneSteps++;
        if (doneSteps == 2 && args.includes("run")) runMain();
      }
    });
    var asciiArtName = usedVersion<2? "old/asciiartB2.js" : "asciiart.js"
    $.ajax({
      url: asciiArtName,
      success: function (JScode) {
        window.eval(JScode);
        console.log("Canvas loaded!");
        doneSteps++;
        if (doneSteps == 2 && args.includes("run")) runMain();
      }
    });
  </script>
</body>
</html>
<!--
  9873｛62｛851｝5｝999991＋＋＋＋［o
  ９８７６５４３２１０１［３４｝９［ｏ
  ５｛[]＊Ｏ
  ６５４（（console.log([1,2,3,4,5,6].map(npop).map(c=>c+""))＃
  ８｛）┐：（╵］）
  abc∙def∙ghi３［-＋｝
  ⇵｛*＊］⤢┼
  >｛⇵-＊|；＋╬│Ｐ
  -＊>＋＋
  __ /|２ｎ╶┤ｒ⇵｛├⁸¹⁸｝ｊ*＋↔│
  ⇵-＊/；＋╶⇵|×∔╬┼
  abc¶def¶ghi∙a＋∙12¶3∙a＋２２╋
  |×╶_××/×««╶⇵［»：］⁷⇵ｍ↕↕┼╬
  Ｗ｛¹％］：Ｄ≡｝¹
-->